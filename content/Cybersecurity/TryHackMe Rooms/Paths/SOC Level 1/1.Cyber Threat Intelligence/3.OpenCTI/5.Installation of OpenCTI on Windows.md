#cybersecurity #soc #home-lab

So I decided to try to install OpenCTI.
First I setup two Ubuntu Server Images

Need to install Docker on both machine

```bash
sudo apt-get update
sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
```


Then add [[gpg]] key on both machines
```bash
curl -fsSl https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```

Add stable repository
```bash
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
```

Install Docker
```bash
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose
```

Make the manager node of the swarm the Opencti01

```bash
sudo docker swarm init --advertise-addr <IP-MANAGER>
```

Run the command on worker node

```bash
sudo docker swarm join --token SWMTKN-1-4ha1gxfvulzinwje3r2x6gw9mgi2pchpwhyldilrk8wbiposdy-48fmc4x2i6l3fttsi4eeddgdj 192.168.188.49:2377
```


Install Portainer su opencti01

```bash
sudo mkdir -p /opt/portainer && cd /opt/portainer
sudo curl -L https://downloads.portainer.io/portainer-agent-stack.yml -o portainer-agent-stack.yml
```

Modify the ports with `nano`

```
ports:
      - "9443:9443"
      - "19000:9000"
      - "18000:8000"
```

We add a 1 in front of 9000 and 8000 because opencti tries to connect to those ports

Launch the container
```bash
sudo docker stack deploy --compose-file=portainer-agent-stack.yml po
rtainer
```

Go to fronted and create user

### Install OpenCTI
https://github.com/OpenCTI-Platform/docker

Create a new stack on portainer
![[Pasted image 20240531141941.png]]

Past the docker compose file when creating

But before commit we have to fix environment variables
We take the .env.sample file from opencti docker github page

Change the uuid and remoeve hostname
```sample
OPENCTI_ADMIN_EMAIL=pooldaimon94@gmail.com
OPENCTI_ADMIN_PASSWORD=**
OPENCTI_ADMIN_TOKEN=3f973d95-9035-414f-be54-79e5716f4950
OPENCTI_BASE_URL=http://localhost:8080
MINIO_ROOT_USER=opencti
MINIO_ROOT_PASSWORD=**
RABBITMQ_DEFAULT_USER=opencti
RABBITMQ_DEFAULT_PASS=**
CONNECTOR_EXPORT_FILE_STIX_ID=79ecbf63-e5b7-4626-bfbe-b99a8b65e377
CONNECTOR_EXPORT_FILE_CSV_ID=28e980ab-0317-4906-a0e2-9fdbfc3e0ef1
CONNECTOR_EXPORT_FILE_TXT_ID=ca715d9c-bd64-4351-91db-33a8d728a58b
CONNECTOR_IMPORT_FILE_STIX_ID=35e9749f-988a-4b04-a133-3988f44673b7
CONNECTOR_IMPORT_DOCUMENT_ID=34821270-d6d1-433a-a1c0-5489d3aa1667
ELASTIC_MEMORY_SIZE=4G
```

Save and upload the file to portainer