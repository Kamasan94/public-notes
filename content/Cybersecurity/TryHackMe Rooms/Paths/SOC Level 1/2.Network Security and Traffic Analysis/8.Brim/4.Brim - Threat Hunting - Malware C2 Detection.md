#cybersecurity #soc #network 

**Let's investigate the traffic sample to detect malicious C2 activities!**

`cut id.orig_h, id.resp_p, id.resp_h | sort  | uniq -c | sort -r count`

This query provides sufficient data that helped us decide where to focus. The IP addresses "10.22.xx" and "104.168.xx" draw attention in the first place.

Let's look at the port numbers and available services before focusing on the suspicious IP address and narrowing our search.

`_path=="conn" | cut id.resp_p, service | sort | uniq -c | sort -r count`

Nothing extremely odd in port numbers, but there is a massive DNS record available. Let's have a closer look.

`_path=="dns" | count() by query | sort -r`

There are out of ordinary DNS queries. Let's enrich our findings by using VirusTotal to identify possible malicious domains.

We have detected two additional malicious IP addresses (we have the IP 45.147.xx from the log files and gathered the 68.138.xx and 185.70.xx from VirusTotal) linked with suspicious DNS queries with the help of external research. Let's look at the HTTP requests before narrowing down our investigation with the found malicious IP addresses.

`_path=="http" | cut id.orig_h, id.resp_h, id.resp_p, method, host, uri | uniq -c | sort value.uri`

We detect a file download request from the IP address we assumed as malicious. Let's validate this idea with VirusTotal and validate our hypothesis.

VirusTotal results show that the IP address "104.xx" is linked with a file. Once we investigate that file, we discover that these two findings are associated with CobaltStrike. Up to here, we've followed the abnormal activity and found the malicious IP addresses. Our findings represent the C2 communication. Now let's conclude our hunt by gathering the low hanging fruits with Suricata logs.

`event_type=="alert" | count() by alert.severity,alert.category | sort count`

Now we can see the overall malicious activities detected by Suricata. Note that you can investigate the rest of the IP addresses to identify the secondary C2 traffic anomaly without using the Suricata logs. This task demonstrates two different approaches to detecting anomalies.

Investigating each alarm category and signature to enhance the threat hunting activities and post-hunting system hardening operations is suggested.

### Questions
**What is the name of the file downloaded from the CobaltStrike C2 connection?**
![[Pasted image 20240612114752.png]]
4564.exe

**What is the number of CobaltStrike connections using port 443?**

`_path=="conn" | 104.168.44.45 | cut id.orig_h, id.resp_p, id.resp_h | sort | uniq -c`
328

**There is an additional C2 channel in used the given case. What is the name of the secondary C2 channel?**
`event_type=="alert" | cut alert.signature | sort -r | uniq -c | sort -r count`
icedID

